---
title: "AirBnB analysis"
author: "MK842 Team 2"
date: "1/12/2018"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r setup2, message=FALSE, echo=FALSE}
library(bit64)
library(data.table)
library(ggplot2)
library(scales)
library(stringr)
theme_set(theme_bw())

if (1) {
  print("Creating training and test data sets from a 50/50 split of the CSV")
  air <- read.csv("listings.csv", stringsAsFactors = TRUE)

  airt <- data.table(air)
  airt[,review_scores_rating:=na.roughfix(review_scores_rating)]
  airt[,review_scores_accuracy:=na.roughfix(review_scores_accuracy)]

  atrain.sampled <- sample(nrow(airt), nrow(airt)/2)
  atrain <- airt[atrain.sampled]
  atest <- airt[!atrain.sampled]
  if (!setequal(union(atest$id, atrain$id), airt$id)) {
    stop("ERROR: The test and training datasets don't add up to the original dataset")
  }

  print("Saving training and test data sets")
  save(atest, file=sprintf("%s/%s", script.dir, "atest.dat"))
  save(atrain, file=sprintf("%s/%s", script.dir, "atrain.dat"))
} else {
  load(file="atrain.dat")
  load(file="atest.dat")
  if (length(intersect(atest$id, atrain$id)) > 0) {
    stop("ERROR: The test and training datasets overlap")
  }
}
```

## Define and Massage Training and Test datasets
```{r datasets, echo=TRUE}
atest[,host_since_date:=as.Date(host_since)]
atrain[,host_since_date:=as.Date(host_since)]


```

## Define the formula
```{r formula, echo=TRUE}

air_formula <- as.formula("price ~
    host_since_date + host_response_time +
    host_response_rate + host_is_superhost +
    host_listings_count + host_total_listings_count + host_verifications +
    host_has_profile_pic + host_identity_verified +
    neighbourhood_cleansed +
    zipcode + latitude + longitude + is_location_exact + property_type +
    room_type + accommodates + bathrooms + bedrooms + beds +
    bed_type + amenities + square_feet + security_deposit + cleaning_fee + guests_included +
    extra_people + minimum_nights + maximum_nights +
    availability_30 + availability_60 + availability_90 +
    availability_365 + number_of_reviews +
    first_review + last_review + review_scores_rating + review_scores_accuracy +
    review_scores_cleanliness + review_scores_checkin + review_scores_communication +
    review_scores_location + review_scores_value +
    instant_bookable + is_business_travel_ready +
    cancellation_policy + require_guest_profile_picture + require_guest_phone_verification +
    calculated_host_listings_count + reviews_per_month")
```

## Build matrices for train and test

Generate a training matrix and a test matrix from the training and test datasets, dropping the first column (`price`).

```{r build_matrices, echo=TRUE}
air.train_input <- model.matrix(air_formula, atrain)[, -1]
air.train_output <- atrain$price

air.test <- model.matrix(air_formula, atest)[, -1]
```

## Random Forest

Run Random Forest algorithm over the training dataset.

```{r prep_matrices, echo=TRUE}
fit.rndfor <- randomForest( air.train_input, air.train_output, do.trace = 0,
                            ntree = 100,
                            sampsize = 1000)
airhat.test.rndfor <- predict(fit.rndfor, air.test)
rsq.rndfor <- mean((atest$price - airhat.test.rndfor) ^ 2)
rsq.rndfor
```

## To be deleted in Final Version: R Markdown

This is an R Markdown presentation. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

## To be deleted in Final Version: Slide with Bullets

- Bullet 1
- Bullet 2
- Bullet 3

## To be deleted in Final Version: Slide with R Output

```{r cars, echo = TRUE}
summary(cars)
```

## To be deleted in Final Version: Slide with Plot

```{r pressure}
plot(pressure)
```

